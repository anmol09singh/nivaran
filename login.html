<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Nivaran</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <a href="index.html" style="display: inline-block;">
                    <img src="light_mode.png" alt="Nivaran Logo" style="cursor: pointer;">
                </a>
                <h2>Welcome Back</h2>
                <p>Login to continue making a difference</p>
            </div>

            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required autofocus>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group form-checkbox">
                    <label>
                        <input type="checkbox" name="remember"> Remember me
                    </label>
                    <a href="reset-password.html" class="forgot-password">Forgot password?</a>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Login</button>
            </form>

            <div class="auth-divider">
                <span>OR</span>
            </div>

            <button class="btn btn-google" onclick="signInWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Sign in with Google
            </button>

            <div class="auth-footer">
                <p>Don't have an account? <a href="signup.html">Sign up</a></p>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Logging you in...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        window.supabase = supabase;
    </script>
    <script src="auth.js"></script>
    <script>
        function showMessage(message, type = 'info') {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'message-modal';
            modal.innerHTML = `
                <div class="message-modal-content ${type}">
                    <div class="message-modal-header">
                        <span class="message-icon">${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}</span>
                        <h3>${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Information'}</h3>
                    </div>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="this.closest('.message-modal').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function signInWithGoogle() {
            try {
                await auth.signInWithGoogle();
            } catch (error) {
                showMessage('Google sign-in failed. Please try again.', 'error');
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            // Add timeout to prevent infinite loading
            const loginTimeout = setTimeout(() => {
                loadingOverlay.style.display = 'none';
                showMessage('Login is taking too long. Please refresh and try again.', 'error');
            }, 10000); // 10 second timeout

            try {
                const formData = new FormData(e.target);
                const email = formData.get('email');
                const password = formData.get('password');
                
                console.log('Attempting login for:', email);
                
                const result = await auth.signIn(email, password);
                
                console.log('Login successful:', result);
                
                clearTimeout(loginTimeout);
                
                console.log('About to redirect, profile state:', {
                    hasProfile: !!auth.currentProfile,
                    profile: auth.currentProfile
                });
                
                // Hide loading overlay before showing message
                loadingOverlay.style.display = 'none';
                
                // Show success message
                showMessage('Login Successful! Redirecting...', 'success');
                
                // Redirect after a short delay
                setTimeout(() => {
                    console.log('Executing redirect...');
                    auth.redirectAfterLogin();
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                clearTimeout(loginTimeout);
                loadingOverlay.style.display = 'none';
                
                // Show error message
                let errorMessage = 'Invalid email or password. Please try again.';
                if (error.message) {
                    if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'Please confirm your email address before logging in. Check your inbox.';
                    } else if (error.message.includes('Invalid')) {
                        errorMessage = 'Invalid email or password.';
                    } else {
                        errorMessage = error.message;
                    }
                }
                showMessage(errorMessage, 'error');
            }
        });

        // Check if already logged in
        auth.getSession().then(session => {
            if (session) {
                auth.redirectToDashboard();
            }
        });
    </script>
</body>
</html>
