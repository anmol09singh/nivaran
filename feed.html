<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed - Nivaran</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" style="display: inline-block;">
                    <img src="light_mode.png" alt="Nivaran Logo" style="cursor: pointer;">
                </a>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-link"><span>üìä</span> Dashboard</a>
                <a href="feed.html" class="nav-link active"><span>üì∞</span> Feed</a>
                <a href="find.html" class="nav-link"><span>üó∫Ô∏è</span> Find NGOs</a>
                <a href="chat-list.html" class="nav-link"><span>üí¨</span> Messages</a>
                <a href="create-post.html" class="nav-link"><span>‚ûï</span> Create Post</a>
                <a href="profile.html" class="nav-link"><span>üë§</span> Profile</a>
                <a href="#" class="nav-link" onclick="logout()"><span>üö™</span> Logout</a>
            </nav>
        </aside>

        <main class="main-content feed-page">
            <!-- Twitter-like Feed Container -->
            <div class="twitter-feed-container">
                <!-- Header -->
                <div class="feed-header">
                    <h1>Home</h1>
                </div>

                <!-- Create Post Box (Twitter-like) -->
                <div class="create-post-box">
                    <div class="post-input-area">
                        <img id="user-avatar-post" src="" alt="Avatar" class="post-avatar">
                        <div class="post-input-wrapper">
                            <textarea id="post-textarea" placeholder="What food do you want to share?" rows="3"></textarea>
                            
                            <!-- Post Details (expandable) -->
                            <div id="post-details" style="display: none;">
                                <div class="post-detail-row">
                                    <input type="text" id="post-food-type" placeholder="Food type (e.g., Cooked, Raw, Packaged)">
                                </div>
                                <div class="post-detail-row">
                                    <input type="text" id="post-quantity" placeholder="Quantity (e.g., 50 servings)">
                                </div>
                                <div class="post-detail-row">
                                    <input type="text" id="post-address" placeholder="Pickup address">
                                </div>
                                <div class="post-detail-row">
                                    <input type="datetime-local" id="post-pickup-time" placeholder="Pickup time">
                                </div>
                            </div>

                            <!-- Image Preview Area -->
                            <div id="image-preview-container" class="image-preview-container" style="display: none;"></div>

                            <!-- Post Actions -->
                            <div class="post-actions-bar">
                                <div class="post-actions-left">
                                    <button class="post-action-btn" title="Add images" onclick="document.getElementById('image-upload').click()">
                                        üñºÔ∏è
                                    </button>
                                    <button class="post-action-btn" title="Add details" onclick="togglePostDetails()">
                                        üìù
                                    </button>
                                    <button class="post-action-btn" title="Add location" onclick="addLocation()">
                                        üìç
                                    </button>
                                    <input type="file" id="image-upload" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
                                </div>
                                <button class="btn btn-primary btn-post" onclick="createPost()" id="post-btn" disabled>
                                    Post
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter Tabs -->
                <div class="feed-tabs">
                    <button class="tab-btn active" data-filter="all" onclick="switchTab('all')">
                        All Posts
                    </button>
                    <button class="tab-btn" data-filter="donor" onclick="switchTab('donor')">
                        Donors
                    </button>
                    <button class="tab-btn" data-filter="ngo" onclick="switchTab('ngo')">
                        NGOs
                    </button>
                </div>

                <!-- Posts Feed -->
                <div id="posts-container" class="twitter-posts-feed"></div>
                
                <!-- Loading State -->
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading posts...</p>
                </div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div class="empty-icon">üì≠</div>
                    <h3>No posts yet</h3>
                    <p>Be the first to share food donations!</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        window.supabase = supabase;
    </script>
    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script src="feed.js"></script>
    <script src="chat.js"></script>
    <script>
        let currentFilter = 'all';
        let currentUserProfile = null;
        let selectedImages = [];

        async function initFeed() {
            await auth.requireAuth();
            
            // Load user profile
            currentUserProfile = auth.getCurrentProfile();
            
            // Set user avatar
            const avatarImg = document.getElementById('user-avatar-post');
            if (currentUserProfile?.profile_image_url) {
                avatarImg.src = currentUserProfile.profile_image_url;
            } else {
                avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUserProfile?.name || 'User')}&background=2563eb&color=fff`;
            }
            
            await loadPosts();
        }

        // Enable/disable post button based on textarea content
        document.getElementById('post-textarea')?.addEventListener('input', function() {
            const postBtn = document.getElementById('post-btn');
            postBtn.disabled = this.value.trim().length === 0;
        });

        // Toggle post details
        function togglePostDetails() {
            const details = document.getElementById('post-details');
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
        }

        // Handle image selection
        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) return;
            
            // Limit to 4 images
            if (selectedImages.length + files.length > 4) {
                alert('You can upload up to 4 images per post.');
                return;
            }
            
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert(`${file.name} is too large. Maximum size is 5MB.`);
                    return;
                }
                
                selectedImages.push(file);
                
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    displayImagePreview(e.target.result, selectedImages.length - 1);
                };
                reader.readAsDataURL(file);
            });
            
            // Reset input
            event.target.value = '';
        }

        // Display image preview
        function displayImagePreview(src, index) {
            const container = document.getElementById('image-preview-container');
            container.style.display = 'flex';
            
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'image-preview-item';
            imgWrapper.innerHTML = `
                <img src="${src}" alt="Preview">
                <button class="remove-image-btn" onclick="removeImage(${index})" title="Remove">
                    ‚úï
                </button>
            `;
            
            container.appendChild(imgWrapper);
        }

        // Remove image
        function removeImage(index) {
            selectedImages.splice(index, 1);
            
            // Rebuild preview
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            
            if (selectedImages.length === 0) {
                container.style.display = 'none';
            } else {
                selectedImages.forEach((file, i) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        displayImagePreview(e.target.result, i);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Add location
        async function addLocation() {
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });

                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // Reverse geocode
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
                );
                const data = await response.json();
                
                if (data.display_name) {
                    document.getElementById('post-address').value = data.display_name;
                    // Show details section if hidden
                    document.getElementById('post-details').style.display = 'block';
                }
            } catch (error) {
                console.error('Location error:', error);
                alert('Could not get your location. Please enter manually.');
            }
        }

        // Create post
        async function createPost() {
            const textarea = document.getElementById('post-textarea');
            const text = textarea.value.trim();
            
            if (!text) return;

            const postBtn = document.getElementById('post-btn');
            postBtn.disabled = true;
            postBtn.textContent = 'Posting...';

            try {
                // Upload images first if any
                let imageUrls = [];
                if (selectedImages.length > 0) {
                    postBtn.textContent = 'Uploading images...';
                    imageUrls = await uploadImages(selectedImages);
                }

                const postData = {
                    title: text.substring(0, 100), // First 100 chars as title
                    body: text,
                    images: imageUrls.length > 0 ? imageUrls : null,
                    food_type: document.getElementById('post-food-type').value || null,
                    quantity: document.getElementById('post-quantity').value || null,
                    pickup_address: document.getElementById('post-address').value || null,
                    pickup_time: document.getElementById('post-pickup-time').value || null,
                    role: currentUserProfile?.role || 'donor',
                    status: 'active'
                };

                // Get user's location if available
                if (currentUserProfile?.lat && currentUserProfile?.lng) {
                    postData.lat = currentUserProfile.lat;
                    postData.lng = currentUserProfile.lng;
                }

                const { data, error } = await supabase
                    .from('posts')
                    .insert([{
                        author_id: auth.getCurrentUser().id,
                        ...postData
                    }])
                    .select()
                    .single();

                if (error) throw error;

                // Clear form
                textarea.value = '';
                document.getElementById('post-food-type').value = '';
                document.getElementById('post-quantity').value = '';
                document.getElementById('post-address').value = '';
                document.getElementById('post-pickup-time').value = '';
                document.getElementById('post-details').style.display = 'none';
                
                // Clear images
                selectedImages = [];
                document.getElementById('image-preview-container').style.display = 'none';
                document.getElementById('image-preview-container').innerHTML = '';

                // Reload posts
                await loadPosts();

                alert('Post created successfully!');
            } catch (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post. Please try again.');
            } finally {
                postBtn.disabled = false;
                postBtn.textContent = 'Post';
            }
        }

        // Upload images to Supabase Storage
        async function uploadImages(files) {
            const uploadedUrls = [];
            
            for (const file of files) {
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
                    const filePath = `posts/${auth.getCurrentUser().id}/${fileName}`;

                    const { data, error } = await supabase.storage
                        .from('post-images')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (error) throw error;

                    // Get public URL
                    const { data: { publicUrl } } = supabase.storage
                        .from('post-images')
                        .getPublicUrl(filePath);

                    uploadedUrls.push(publicUrl);
                } catch (error) {
                    console.error('Error uploading image:', error);
                    // Continue with other images even if one fails
                }
            }
            
            return uploadedUrls;
        }

        // Switch tab filter
        function switchTab(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadPosts();
        }

        async function loadPosts() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('posts-container');
            const emptyState = document.getElementById('empty-state');
            
            loading.style.display = 'flex';
            container.innerHTML = '';
            emptyState.style.display = 'none';

            try {
                let query = supabase
                    .from('posts')
                    .select(`
                        *,
                        users:author_id (
                            name,
                            role,
                            profile_image_url
                        )
                    `)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                // Apply filter
                if (currentFilter !== 'all') {
                    query = query.eq('role', currentFilter);
                }

                const { data: posts, error } = await query;

                if (error) throw error;

                if (!posts || posts.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }

                renderTwitterPosts(posts, container);
            } catch (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<div class="error-state">Failed to load posts. Please refresh the page.</div>';
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderTwitterPosts(posts, container) {
            posts.forEach(post => {
                const postEl = createTwitterPostElement(post);
                container.appendChild(postEl);
            });
        }

        function createTwitterPostElement(post) {
            const div = document.createElement('div');
            div.className = 'twitter-post';
            
            const author = post.users || {};
            const avatarUrl = author.profile_image_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(author.name || 'User')}&background=random`;
            const timeAgo = getTimeAgo(new Date(post.created_at));

            // Build images HTML
            let imagesHtml = '';
            if (post.images && post.images.length > 0) {
                const imageCount = post.images.length;
                const gridClass = imageCount === 1 ? 'single' : imageCount === 2 ? 'double' : 'multiple';
                
                imagesHtml = `<div class="post-images ${gridClass}">`;
                
                post.images.forEach((imageUrl, index) => {
                    if (index < 4) { // Limit to 4 images
                        imagesHtml += `
                            <div class="post-image-item" onclick="openImageModal('${imageUrl}', ${JSON.stringify(post.images).replace(/"/g, '&quot;')}, ${index})">
                                <img src="${imageUrl}" alt="Post image ${index + 1}" loading="lazy">
                                ${imageCount > 4 && index === 3 ? `<div class="more-images-overlay">+${imageCount - 4}</div>` : ''}
                            </div>
                        `;
                    }
                });
                
                imagesHtml += '</div>';
            }

            div.innerHTML = `
                <div class="post-avatar-container">
                    <img src="${avatarUrl}" alt="${author.name}" class="post-avatar">
                </div>
                <div class="post-content-main">
                    <div class="post-header-info">
                        <span class="post-author-name">${author.name || 'Unknown'}</span>
                        <span class="post-role-badge ${post.role}">${post.role === 'donor' ? 'üéÅ Donor' : 'üè¢ NGO'}</span>
                        <span class="post-time">¬∑ ${timeAgo}</span>
                    </div>
                    <div class="post-text">${post.body || post.title}</div>
                    ${imagesHtml}
                    ${post.food_type || post.quantity || post.pickup_address ? `
                    <div class="post-details-display">
                        ${post.food_type ? `<div class="detail-tag">üçΩÔ∏è ${post.food_type}</div>` : ''}
                        ${post.quantity ? `<div class="detail-tag">üì¶ ${post.quantity}</div>` : ''}
                        ${post.pickup_address ? `<div class="detail-tag">üìç ${post.pickup_address}</div>` : ''}
                    </div>
                    ` : ''}
                    <div class="post-actions-row">
                        <button class="post-action-icon" onclick="chatWithAuthor('${post.author_id}')" title="Message">
                            üí¨ Message
                        </button>
                        <button class="post-action-icon" onclick="sharePost('${post.id}')" title="Share">
                            üîó Share
                        </button>
                    </div>
                </div>
            `;

            return div;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + 'y';
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + 'mo';
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + 'd';
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + 'h';
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + 'm';
            
            return Math.floor(seconds) + 's';
        }

        async function chatWithAuthor(authorId) {
            window.location.href = `chat.html?user=${authorId}`;
        }

        function sharePost(postId) {
            const url = `${window.location.origin}/post.html?id=${postId}`;
            navigator.clipboard.writeText(url);
            alert('Link copied to clipboard!');
        }

        // Image modal functions
        let currentImageIndex = 0;
        let currentImages = [];

        function openImageModal(imageUrl, images, index) {
            currentImages = typeof images === 'string' ? JSON.parse(images) : images;
            currentImageIndex = index;
            
            // Create modal if it doesn't exist
            let modal = document.getElementById('image-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'image-modal';
                modal.className = 'image-modal';
                modal.innerHTML = `
                    <div class="image-modal-content">
                        <button class="modal-close" onclick="closeImageModal()">‚úï</button>
                        <button class="modal-nav modal-prev" onclick="navigateImage(-1)">‚Äπ</button>
                        <img id="modal-image" src="" alt="Full size image">
                        <button class="modal-nav modal-next" onclick="navigateImage(1)">‚Ä∫</button>
                        <div class="image-counter"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            updateModalImage();
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function navigateImage(direction) {
            currentImageIndex += direction;
            if (currentImageIndex < 0) currentImageIndex = currentImages.length - 1;
            if (currentImageIndex >= currentImages.length) currentImageIndex = 0;
            updateModalImage();
        }

        function updateModalImage() {
            const img = document.getElementById('modal-image');
            const counter = document.querySelector('.image-counter');
            
            if (img && currentImages[currentImageIndex]) {
                img.src = currentImages[currentImageIndex];
            }
            
            if (counter) {
                counter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
                counter.style.display = currentImages.length > 1 ? 'block' : 'none';
            }
            
            // Show/hide navigation buttons
            const prevBtn = document.querySelector('.modal-prev');
            const nextBtn = document.querySelector('.modal-next');
            if (currentImages.length <= 1) {
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            } else {
                if (prevBtn) prevBtn.style.display = 'flex';
                if (nextBtn) nextBtn.style.display = 'flex';
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeImageModal();
            if (e.key === 'ArrowLeft') navigateImage(-1);
            if (e.key === 'ArrowRight') navigateImage(1);
        });

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await auth.signOut();
            }
        }

        // Initialize feed
        initFeed();
    </script>
</body>
</html>
