<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - Nivaran</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card profile-complete-card">
            <div class="auth-header">
                <img src="light_mode.png" alt="Nivaran Logo">
                <h2>Complete Your Profile</h2>
                <p>Please provide the following information to continue</p>
            </div>

            <form id="complete-profile-form" class="auth-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="username">Username *</label>
                        <input type="text" id="username" name="username" required>
                        <small>This will be your display name</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" id="email" name="email" required readonly>
                        <small>Email cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number *</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bio">Bio</label>
                    <textarea id="bio" name="bio" rows="3" placeholder="Tell us about yourself..."></textarea>
                    <small>Optional: Add a brief description about yourself or your organization</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" name="city" required>
                    </div>

                    <div class="form-group">
                        <label for="state">State *</label>
                        <input type="text" id="state" name="state" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="profile_pic">Profile Picture</label>
                    <input type="file" id="profile_pic" name="profile_pic" accept="image/*">
                    <div id="image-preview" class="profile-image-preview" style="display: none;">
                        <img id="preview-img" src="" alt="Preview">
                        <button type="button" class="remove-preview" onclick="removePreview()">Remove</button>
                    </div>
                    <small>Optional: Upload a profile picture (Max 5MB)</small>
                </div>

                <div class="form-group">
                    <label for="address">Full Address</label>
                    <textarea id="address" name="address" rows="2" placeholder="Enter your complete address"></textarea>
                    <small>This helps NGOs/donors find you nearby</small>
                </div>

                <button type="submit" class="btn btn-primary btn-block" id="submit-btn">
                    Complete Profile
                </button>
            </form>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Updating your profile...</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        window.supabase = supabase;
    </script>
    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script>
        let selectedImage = null;
        let userLocation = null;

        // Check if user needs to complete profile
        async function initProfileCompletion() {
            try {
                const session = await auth.getSession();
                
                if (!session) {
                    window.location.href = '/login.html';
                    return;
                }

                const currentUser = auth.getCurrentUser();
                const currentProfile = auth.getCurrentProfile();

                // Pre-fill email
                document.getElementById('email').value = currentUser.email;

                // If profile exists, pre-fill existing data
                if (currentProfile) {
                    if (currentProfile.name) {
                        document.getElementById('username').value = currentProfile.name;
                    }
                    if (currentProfile.phone) {
                        document.getElementById('phone').value = currentProfile.phone;
                    }
                    if (currentProfile.bio) {
                        document.getElementById('bio').value = currentProfile.bio;
                    }
                    if (currentProfile.address) {
                        document.getElementById('address').value = currentProfile.address;
                        // Try to extract city and state from address
                        extractLocationFromAddress(currentProfile.address);
                    }
                }

                // Get user's location for address suggestion
                getUserLocation();

            } catch (error) {
                console.error('Init error:', error);
            }
        }

        // Extract city and state from address
        function extractLocationFromAddress(address) {
            // Simple extraction - you can make this more sophisticated
            const parts = address.split(',').map(p => p.trim());
            if (parts.length >= 2) {
                const stateField = document.getElementById('state');
                const cityField = document.getElementById('city');
                
                if (!stateField.value && parts[parts.length - 1]) {
                    stateField.value = parts[parts.length - 1];
                }
                if (!cityField.value && parts[parts.length - 2]) {
                    cityField.value = parts[parts.length - 2];
                }
            }
        }

        // Get user's current location
        async function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        // Reverse geocode to get address
                        try {
                            const response = await fetch(
                                `https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLocation.lat}&lon=${userLocation.lng}`
                            );
                            const data = await response.json();
                            
                            if (data && data.address) {
                                const addressField = document.getElementById('address');
                                const cityField = document.getElementById('city');
                                const stateField = document.getElementById('state');
                                
                                if (!addressField.value && data.display_name) {
                                    addressField.value = data.display_name;
                                }
                                if (!cityField.value && data.address.city) {
                                    cityField.value = data.address.city || data.address.town || data.address.village || '';
                                }
                                if (!stateField.value && data.address.state) {
                                    stateField.value = data.address.state || '';
                                }
                            }
                        } catch (error) {
                            console.error('Geocoding error:', error);
                        }
                    },
                    (error) => {
                        console.log('Location access denied or unavailable');
                    }
                );
            }
        }

        // Handle profile picture preview
        document.getElementById('profile_pic').addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            if (file) {
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    e.target.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    e.target.value = '';
                    return;
                }

                selectedImage = file;

                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // Remove preview
        function removePreview() {
            selectedImage = null;
            document.getElementById('profile_pic').value = '';
            document.getElementById('image-preview').style.display = 'none';
        }

        // Handle form submission
        document.getElementById('complete-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const loadingOverlay = document.getElementById('loading-overlay');
            const submitBtn = document.getElementById('submit-btn');
            
            loadingOverlay.style.display = 'flex';
            submitBtn.disabled = true;

            try {
                const currentUser = auth.getCurrentUser();
                
                if (!currentUser) {
                    throw new Error('User not authenticated');
                }

                // Upload profile picture if selected
                let profileImageUrl = null;
                if (selectedImage) {
                    try {
                        const fileExt = selectedImage.name.split('.').pop();
                        const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
                        const filePath = `profiles/${fileName}`;

                        profileImageUrl = await api.uploadImage('profile-images', filePath, selectedImage);
                    } catch (uploadError) {
                        console.error('Image upload error:', uploadError);
                        // Continue without image
                    }
                }

                // Prepare update data
                const formData = new FormData(e.target);
                const updateData = {
                    name: formData.get('username'),
                    phone: formData.get('phone'),
                    bio: formData.get('bio') || null,
                    address: formData.get('address') || null,
                    city: formData.get('city'),
                    state: formData.get('state'),
                    profile_image_url: profileImageUrl,
                    lat: userLocation?.lat || null,
                    lng: userLocation?.lng || null,
                    profile_completed: true
                };

                // Update user profile
                const updatedProfile = await api.updateUserProfile(currentUser.id, updateData);

                // Reload profile in auth
                await auth.loadUserProfile();

                // Show success message
                showMessage('Profile completed successfully! Redirecting...', 'success');

                // Redirect to dashboard
                setTimeout(() => {
                    auth.redirectToDashboard();
                }, 1500);

            } catch (error) {
                console.error('Profile completion error:', error);
                loadingOverlay.style.display = 'none';
                submitBtn.disabled = false;
                showMessage(error.message || 'Failed to update profile. Please try again.', 'error');
            }
        });

        function showMessage(message, type = 'info') {
            const modal = document.createElement('div');
            modal.className = 'message-modal';
            modal.innerHTML = `
                <div class="message-modal-content ${type}">
                    <div class="message-modal-header">
                        <span class="message-icon">${type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ'}</span>
                        <h3>${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Information'}</h3>
                    </div>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="this.closest('.message-modal').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize on page load
        initProfileCompletion();
    </script>
</body>
</html>
